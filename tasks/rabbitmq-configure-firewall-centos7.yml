---
- name: Open AMQP Port
  when: rabbitmq.config.listeners.tcp is defined
  firewalld:
    port: 5672/tcp
    state: enabled
    permanent: true
    immediate: true

- name: Close AMQP Port
  when: rabbitmq.config.listeners.tcp is not defined
  firewalld:
    port: 5672/tcp
    state: disabled
    permanent: true
    immediate: true

- name: Open AMQP SSL Port
  when: rabbitmq.config.listeners.ssl is defined and rabbitmq.ssl is defined
  firewalld:
    port: 5671/tcp
    state: enabled
    permanent: true
    immediate: true

- name: Close AMQP SSL Port
  when: rabbitmq.config.listeners.ssl is not defined and rabbitmq.ssl is not defined
  firewalld:
    port: 5671/tcp
    state: disabled
    permanent: true
    immediate: true

- name: Open Management Port
  when: "'rabbitmq_management' in rabbitmq.plugins and rabbitmq.config.management.tcp.ip is defined"
  firewalld:
    port: 15672/tcp
    state: enabled
    permanent: true
    immediate: true

- name: Close Management Port
  when: "'rabbitmq_management' not in rabbitmq.plugins or rabbitmq.config.management.tcp.ip is not defined"
  firewalld:
    port: 15672/tcp
    state: disabled
    permanent: true
    immediate: true
  
- name: Open Management SSL Port
  when: "'rabbitmq_management' in rabbitmq.plugins and rabbitmq.config.ssl is defined"
  firewalld:
    port: 15671/tcp
    state: enabled
    permanent: true
    immediate: true

- name: Close Management SSL Port
  when: "'rabbitmq_management' not in rabbitmq.plugins or rabbitmq.config.ssl is not defined"
  firewalld:
    port: 15671/tcp
    state: disabled
    permanent: true
    immediate: true


# - name: Open Management Port
#   when: "'rabbitmq_management' in rabbitmq.plugins"
#   firewalld:
#     port: 15672/tcp
#     state: enabled
#     permanent: yes
#     immediate: yes
#   loop: "{{ rabbitmq.allow_management_cidrs | flatten(levels=1) }}"

# - name: Open MQTT Ports
#   when: "'rabbitmq_mqtt' in rabbitmq.plugins"
#   block:
#     - name: Open MQTT Port
#       when: rabbitmq.allow_insecure|default(false) == true
#       firewalld:
#         port: 1883/tcp
#         state: enabled
#         permanent: yes
#         immediate: yes
#       loop: "{{ rabbitmq.allow_mqtt_cidrs | flatten(levels=1) }}"
#     - name: Open MQTT SSL Port
#       when: rabbitmq.ssl is defined
#       firewalld:
#         port: 8883/tcp
#         state: enabled
#         permanent: yes
#         immediate: yes
#       loop: "{{ rabbitmq.allow_mqtt_cidrs | flatten(levels=1) }}"
