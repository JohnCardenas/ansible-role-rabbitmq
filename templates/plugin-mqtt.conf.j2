## ----------------------------------------------------------------------------
## RabbitMQ MQTT Adapter
##
## See https://github.com/rabbitmq/rabbitmq-mqtt/blob/stable/README.md
## for details
## ----------------------------------------------------------------------------

# =======================================
# MQTT section
# =======================================

## TCP listener settings.
##
# mqtt.listeners.tcp.1 = 127.0.0.1:61613
# mqtt.listeners.tcp.2 = ::1:61613
{% for item in rabbitmq.config.mqtt.listeners.tcp|default([]) %}
mqtt.listeners.tcp.{{loop.index}} = {{item}}:1883
{% endfor %}

## TCP listener options (as per the broker configuration).
##
# mqtt.tcp_listen_options.backlog = 4096
# mqtt.tcp_listen_options.recbuf  = 131072
# mqtt.tcp_listen_options.sndbuf  = 131072
#
# mqtt.tcp_listen_options.keepalive = true
# mqtt.tcp_listen_options.nodelay   = true
#
# mqtt.tcp_listen_options.exit_on_close = true
# mqtt.tcp_listen_options.send_timeout  = 120

{% if rabbitmq.config.mqtt.tcp_listen_options is defined %}
mqtt.tcp_listen_options.backlog = {{ rabbitmq.config.mqtt.tcp_listen_options.backlog|default(4096) }}
mqtt.tcp_listen_options.recbuf  = {{ rabbitmq.config.mqtt.tcp_listen_options.recbuf|default(131072) }}
mqtt.tcp_listen_options.sndbuf  = {{ rabbitmq.config.mqtt.tcp_listen_options.sndbuf|default(131072) }}

mqtt.tcp_listen_options.keepalive = {{ rabbitmq.config.mqtt.tcp_listen_options.keepalive|default('true') }}
mqtt.tcp_listen_options.nodelay   = {{ rabbitmq.config.mqtt.tcp_listen_options.nodelay|default('true') }}

mqtt.tcp_listen_options.exit_on_close = {{ rabbitmq.config.mqtt.tcp_listen_options.exit_on_close|default('true') }}
mqtt.tcp_listen_options.send_timeout  = {{ rabbitmq.config.mqtt.tcp_listen_options.send_timeout|default(120) }}
{% endif %}

## TLS listener settings
## ## See https://rabbitmq.com/mqtt.html and https://rabbitmq.com/ssl.html for details.
#
# mqtt.listeners.ssl.default = 8883
#
# ssl_options.cacertfile = /path/to/tls/ca_certificate_bundle.pem
# ssl_options.certfile   = /path/to/tls/server_certificate.pem
# ssl_options.keyfile    = /path/to/tls/server_key.pem
# ssl_options.verify     = verify_peer
# ssl_options.fail_if_no_peer_cert  = true
#
{% for item in rabbitmq.config.mqtt.listeners.ssl|default([]) %}
mqtt.listeners.ssl.{{loop.index}} = {{item}}:8883
{% endfor %}

## Number of Erlang processes that will accept connections for the TCP
## and TLS listeners.
##
# mqtt.num_acceptors.tcp = 10
# mqtt.num_acceptors.ssl = 10
{% if rabbitmq.config.mqtt.num_acceptors.tcp is defined %}
mqtt.num_acceptors.tcp = {{ rabbitmq.config.mqtt.num_acceptors.tcp|default(10) }}
{% endif %}
{% if rabbitmq.config.mqtt.num_acceptors.ssl is defined %}
mqtt.num_acceptors.ssl = {{ rabbitmq.config.mqtt.num_acceptors.ssl|default(10) }}
{% endif %}

## Whether or not to enable proxy protocol support.
## Once enabled, clients cannot directly connect to the broker
## anymore. They must connect through a load balancer that sends the
## proxy protocol header to the broker at connection time.
## This setting applies only to STOMP clients, other protocols
## like STOMP or AMQP have their own setting to enable proxy protocol.
## See the plugins or broker documentation for more information.
##
# mqtt.proxy_protocol = false
{% if rabbitmq.config.mqtt.proxy_protocol is defined %}
mqtt.proxy_protocol = {{ rabbitmq.config.mqtt.proxy_protocol|default('false') }}
{% endif %}

## Set the default user name and password used for anonymous connections (when client
## provides no credentials). Anonymous connections are highly discouraged!
##
# mqtt.default_user = guest
# mqtt.default_pass = guest
{% if rabbitmq.config.mqtt.default_user is defined %}
mqtt.default_user = {{ rabbitmq.config.mqtt.default_user|default('guest') }}
{% endif %}
{% if rabbitmq.config.mqtt.default_pass is defined %}
mqtt.default_pass = {{ rabbitmq.config.mqtt.default_pass|default('guest') }}
{% endif %}

## Enable anonymous connections. If this is set to false, clients MUST provide
## credentials in order to connect. See also the mqtt.default_user/mqtt.default_pass
## keys. Anonymous connections are highly discouraged!
##
# mqtt.allow_anonymous = true
{% if rabbitmq.config.mqtt.allow_anonymous is defined %}
mqtt.allow_anonymous = {{ rabbitmq.config.mqtt.allow_anonymous|default('false') }}
{% endif %}

## If you have multiple vhosts, specify the one to which the
## adapter connects.
##
# mqtt.vhost = /
{% if rabbitmq.config.mqtt.vhost is defined %}
mqtt.vhost = {{ rabbitmq.config.mqtt.vhost }}
{% endif %}

## Specify the exchange to which messages from MQTT clients are published.
##
# mqtt.exchange = amq.topic
{% if rabbitmq.config.mqtt.exchange is defined %}
mqtt.exchange = {{ rabbitmq.config.mqtt.exchange }}
{% endif %}

## Specify TTL (time to live) to control the lifetime of non-clean sessions.
##
# mqtt.subscription_ttl = 1800000
{% if rabbitmq.config.mqtt.subscription_ttl is defined %}
mqtt.subscription_ttl = {{ rabbitmq.config.mqtt.subscription_ttl|default(1800000) }}
{% endif %}

## Set the prefetch count (governing the maximum number of unacknowledged
## messages that will be delivered).
##
# mqtt.prefetch = 10
{% if rabbitmq.config.mqtt.prefetch is defined %}
mqtt.prefetch = {{ rabbitmq.config.mqtt.prefetch|default(10) }}
{% endif %}


